- name: Find latest version of yubikey-touch-detector
  uri:
    url: https://api.github.com/repos/maximbaz/yubikey-touch-detector/releases/latest
    return_content: true
  register: latest_release

- name: Set ytd version
  when: ytd_version is not defined
  set_fact:
    ytd_version: "{{ (latest_release.content | from_json).tag_name }}"

- name: Check current ytd version
  command: yubikey-touch-detector -version
  register: ytd_output
  ignore_errors: true
  changed_when: False

- name: Set current ytd version
  when: ytd_output is succeeded
  set_fact:
    current_ytd_version: "{{ ytd_output.stdout_lines[0] | regex_search('([0-9]+\\.){2}[0-9]+') }}"

- name: Create temporary build directory
  when: current_ytd_version | default('none') != ytd_version
  tempfile:
    state: directory
    prefix: ytd_build_
  register: build_dir

- name: Build yubikey-touch-detector in container
  when: current_ytd_version | default('none') != ytd_version
  command: |
    podman run --rm -v {{ build_dir.path }}:/output \
      --security-opt label=disable golang:latest \
      /bin/bash -c "apt-get update && apt-get install -y libgpgme-dev && cd /tmp && go install -ldflags '-X main.version={{ ytd_version }}' github.com/maximbaz/yubikey-touch-detector@{{ ytd_version }} && cp /go/bin/yubikey-touch-detector /output/"

- name: Copy the binary to /usr/local/bin/
  when: current_ytd_version | default('none') != ytd_version
  become: true
  copy:
    src: "{{ build_dir.path }}/yubikey-touch-detector"
    dest: /usr/local/bin/yubikey-touch-detector
    mode: '0755'
    remote_src: true
    force: true

- name: Clean up build directory
  when: current_ytd_version | default('none') != ytd_version
  file:
    path: "{{ build_dir.path }}"
    state: absent

- name: Ensure user systemd folder
  file:
    path: /home/{{ ansible_user_id }}/.config/systemd/user
    state: directory

- name: Add systemd unit for yubikey-touch-detector
  copy:
    src: yubikey-touch-detector.service
    dest: /home/{{ ansible_user_id }}/.config/systemd/user/yubikey-touch-detector.service

- name: Enable yubikey-touch-detector service
  systemd:
    name: yubikey-touch-detector
    state: started
    enabled: true
    scope: user
